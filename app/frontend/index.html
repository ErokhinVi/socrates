<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Raiffeisen Bank Chat</title>

  <link rel="stylesheet" href="/static/style.css" />
  <!-- Markdown‑парсер -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <div class="container">
    <!-- ─────────────────────────  SIDEBAR  ────────────────────────── -->
    <aside class="sidebar">
      <div class="logo-header">
        <img src="/static/images/raif_logo.png" alt="Raiffeisen Logo" class="header-icon" />
      </div>

      <div class="sidebar-buttons">
        <button id="btnInterview"  class="sidebar-btn">Провести интервью</button>
        <button id="btnEvaluate"   class="sidebar-btn">Оценить интервью</button>
        <button id="btnProfession" class="sidebar-btn">Узнать о&nbsp;профессии</button>
      </div>
    </aside>

    <!-- ────────────────────────  MAIN CONTENT  ─────────────────────── -->
    <main class="main-content">

      <!-- Домашний экран -->
      <section id="view-home" class="view">
        <div class="home-welcome">
          <h1>Добро пожаловать в Raiffeisen Bank Chat</h1>
          <p>Выберите действие слева, чтобы начать.</p>
        </div>
      </section>

      <!-- Форма профиля кандидата -->
      <section id="view-interview-form" class="view" style="display:none;">
        <div class="card">
          <h2 class="card-title">Опишите профиль кандидата</h2>
          <form id="personaForm" class="form-column">
            <label>
              <span class="label-text">Профиль кандидата:</span>
              <input type="text" id="inputPersona" placeholder="Data Scientist" required />
            </label>

            <label>
              <span class="label-text">Выдели основные компетенции кандидата:</span>
              <input type="text" id="inputSkill" placeholder="Например - проактивность, тайм менеджмент, ответственность..." required />
            </label>

            <button type="submit" class="primary-btn w-full">Перейти к интервью</button>
          </form>
        </div>
      </section>

      <!-- Чат интервью -->
      <section id="view-interview-chat" class="view" style="display:none;">
        <div class="chat-area">
            <div class="chat-info">
                <h2 class="chat-heading">Текущая сессия интервью</h2>
              
                <!-- flex‑контейнер для мета‑информации -->
                <div class="chat-meta">
                  <div class="meta-item">
                    <strong>Профиль кандидата:</strong>
                    <span id="personaDisplay"></span>
                  </div>
                  <div class="meta-item">
                    <strong>Компетенции:</strong>
                    <span id="skillDisplay"></span>
                  </div>
                </div>
              </div>

          <div id="connection-status" class="status-toast hidden"></div>

          <div id="messages" class="messages"></div>

          <form id="chat-form" class="input-area" onsubmit="sendMessage(event)">
            <input type="text" id="messageText" placeholder="Введите сообщение" disabled />
            <button type="submit" id="send-btn" disabled>
              <img src="/static/icons/send.svg" alt="Отправить" />
            </button>
          </form>

          <div class="chat-actions">
            <button id="endInterviewBtn" class="primary-btn">Завершить интервью</button>
            <button id="recordButton"  class="primary-btn secondary" disabled>Записать голос</button>
          </div>
        </div>
      </section>

      <!-- Экран оценки (STAR) -->
      <section id="view-evaluation" class="view" style="display:none;">
        <div class="card">
          <h2 class="card-title">Оценка интервью (метод STAR)</h2>
          <div id="evaluationContent" class="space-y-2"></div>
          <button id="evalBackBtn" class="primary-btn mt-4">На главную</button>
        </div>
      </section>

      <!-- Экран «Узнать о профессии» -->
      <section id="view-newprofession" class="view" style="display:none;">
        <div class="card">
          <h2 class="card-title">Узнать о профессии</h2>
          <p>Информация о профессии…</p>
        </div>
      </section>

    </main>
  </div>

  <!-- ───────────────────────────  JS  ─────────────────────────────── -->
  <script>
    /* ---------- переключение экранов ---------- */
    function showView(id) {
      document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
      document.getElementById(id).style.display = '';
    }
    const buttons = {
      btnInterview:  'view-interview-form',
      btnEvaluate:   'view-evaluation',
      btnProfession: 'view-newprofession',
    };
    Object.entries(buttons).forEach(([btn, view]) =>
      document.getElementById(btn).onclick = () => showView(view)
    );
    document.getElementById('evalBackBtn').onclick = () => showView('view-home');

    /* ---------- форма профиля ---------- */
    document.getElementById('personaForm').onsubmit = e => {
      e.preventDefault();
      const persona = document.getElementById('inputPersona').value.trim();
      const skill   = document.getElementById('inputSkill').value.trim();
      document.getElementById('personaDisplay').textContent = persona;
      document.getElementById('skillDisplay').textContent   = skill;
      showView('view-interview-chat');
      initInterview(persona, skill);
    };

    // стартуем с домашнего экрана
    showView('view-home');

    /* ─────────────────────  WebSocket‑логика  ────────────────────── */
    let ws,
        isConnected = false,
        isWaitingForResponse = false,
        mediaRecorder, audioChunks = [],
        conversationHistory = [];

    function initInterview(persona, skill) {
      connectWebSocket(persona, skill);
    }

    function connectWebSocket(persona, skill) {
      const proto = location.protocol === 'https:' ? 'wss' : 'ws';
      const url   = `${proto}://${location.host}/ws/interview?persona=${encodeURIComponent(persona)}&skill=${encodeURIComponent(skill)}`;

      ws = new WebSocket(url);
      updateConnectionStatus('Подключение…', 'yellow');

      ws.onopen    = () => {
        isConnected = true;
        updateConnectionStatus('Подключено', 'green');
        setTimeout(hideStatusMessage, 1000);
        enableInterface();
      };
      ws.onmessage = handleWebSocketMessage;
      ws.onerror   = () => updateConnectionStatus('Ошибка соединения', 'red');
      ws.onclose   = () => {
        isConnected = false;
        updateConnectionStatus('Соединение закрыто', 'yellow');
      };
    }

    function handleWebSocketMessage(event) {
      const resp = JSON.parse(event.data);

      if (resp.type === 'error') {
        return updateConnectionStatus(resp.text, 'red');
      }

      if (['text', 'voice'].includes(resp.type)) {
        addAssistantMessage(resp.content);
        if (resp.type === 'voice' && resp.audio) playAudio(resp.audio);
        updateChatDisplay();
        hideStatusMessage();
        isWaitingForResponse = false;
        enableInterface();
        return;
      }

      if (resp.type === 'star_summary') {
        renderStarEvaluation(resp.star);
        if (ws) ws.close(1000, 'Interview finished');
      }
    }

    function sendMessage(e) {
      e.preventDefault();
      if (!isConnected || isWaitingForResponse) return;

      const input = document.getElementById('messageText');
      const msg   = input.value.trim();
      if (!msg) return;

      addUserMessage(msg);
      updateChatDisplay();

      ws.send(JSON.stringify({ type: 'text', message: msg }));

      input.value          = '';
      isWaitingForResponse = true;
      disableInterface();
    }

    document.getElementById('endInterviewBtn').onclick = () => {
      if (!isConnected) { showView('view-home'); return; }

      disableInterface();
      isWaitingForResponse = true;
      updateConnectionStatus('Формируется итоговая оценка…', 'yellow');

      ws.send(JSON.stringify({ type: 'end' }));
    };

    /* ---------- вспомогательные функции ---------- */
    function addUserMessage(txt)      { conversationHistory.push({ role: 'user',      content: txt }); }
    function addAssistantMessage(txt) { conversationHistory.push({ role: 'assistant', content: txt }); }

    function updateChatDisplay() {
      const el = document.getElementById('messages');
      el.innerHTML = '';
      conversationHistory.forEach(m => {
        const d = document.createElement('div');
        if (m.role === 'assistant') {
          d.className = 'message-assistant';
          d.innerHTML = marked.parse(m.content);
        } else {
          d.className = 'message-user';
          d.textContent = m.content;
        }
        el.appendChild(d);
      });
      el.scrollTop = el.scrollHeight;     /* автоскролл вниз */
    }

    function updateConnectionStatus(msg, color) {
      const st = document.getElementById('connection-status');
      const map = { yellow:'bg-yellow', green:'bg-green', red:'bg-red' };
      st.className = `status-toast ${map[color] || 'bg-yellow'}`;
      st.textContent = msg;
      st.classList.remove('hidden');
    }
    function hideStatusMessage()           { document.getElementById('connection-status').classList.add('hidden'); }
    function enableInterface()             { setInterfaceDisabled(false); }
    function disableInterface()            { setInterfaceDisabled(true); }
    function setInterfaceDisabled(state) {
      document.getElementById('messageText').disabled  = state;
      document.getElementById('send-btn').disabled     = state;
      document.getElementById('recordButton').disabled = state;
    }

    function playAudio(base64) {
      const audio = new Audio('data:audio/mp3;base64,' + base64);
      audio.play().catch(() => {});
    }

    function renderStarEvaluation(star) {
      const wrap = document.getElementById('evaluationContent');
      const make = (k, v) => `<div><strong>${k}:</strong><br><span class="whitespace-pre-line">${marked.parseInline(v)}</span></div>`;
      wrap.innerHTML = `
        ${make('Situation', star.Situation || star.S)}
        ${make('Task',      star.Task      || star.T)}
        ${make('Action',    star.Action    || star.A)}
        ${make('Result',    star.Result    || star.R)}
      `;
      showView('view-evaluation');
    }

    document.getElementById('recordButton').onclick = () => {
      /* логика записи, если нужна */
    };
  </script>
</body>
</html>
