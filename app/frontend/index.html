<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Raiffeisen Bank Chat</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <div class="container">
    <aside class="sidebar">
      <div class="logo-header">
        <img src="/static/images/raif_logo.png" alt="Raiffeisen Logo" class="header-icon" />
      </div>
      <div class="sidebar-buttons">
        <button id="btnInterview" class="btn sidebar-btn">–ü—Ä–æ–≤–µ—Å—Ç–∏<br/>–∏–Ω—Ç–µ—Ä–≤—å—é</button>
        <button id="btnEvaluate" class="btn sidebar-btn">–û—Ü–µ–Ω–∏—Ç—å<br/>–∏–Ω—Ç–µ—Ä–≤—å—é</button>
        <button id="btnProfession" class="btn sidebar-btn">–£–∑–Ω–∞—Ç—å –æ<br/>–ø—Ä–æ—Ñ–µ—Å—Å–∏–∏</button>
      </div>
    </aside>

    <div class="main-content">
      <!-- –î–æ–º–∞—à–Ω–∏–π —ç–∫—Ä–∞–Ω -->
      <section id="view-home" class="view">
        <div class="welcome-screen">
          <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Raiffeisen Bank Chat</h1>
          <p>–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å.</p>
        </div>
      </section>

      <!-- –§–æ—Ä–º–∞ –∏–Ω—Ç–µ—Ä–≤—å—é -->
      <section id="view-interview-form" class="view" style="display:none">
        <div class="bg-white shadow mt-6 p-6 rounded w-full max-w-4xl">
          <h1 class="text-xl font-bold mb-4">–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞</h1>
          <form id="personaForm" class="space-y-4">
            <label class="block">
              –ü—Ä–æ—Ñ–∏–ª—å:
              <input type="text" id="inputPersona" class="mt-1 p-2 border rounded w-full" placeholder="Data Scientist" required />
            </label>
            <label class="block">
              –ù–∞–≤—ã–∫:
              <input type="text" id="inputSkill" class="mt-1 p-2 border rounded w-full" placeholder="ML –Ω–∞–π–º" required />
            </label>
            <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded w-full">–ü–µ—Ä–µ–π—Ç–∏ –∫ –∏–Ω—Ç–µ—Ä–≤—å—é</button>
          </form>
        </div>
      </section>

      <!-- –ß–∞—Ç-–∏–Ω—Ç–µ—Ä–≤—å—é -->
      <section id="view-interview-chat" class="view" style="display:none">
        <div class="bg-white shadow mt-6 p-6 rounded w-full max-w-4xl flex flex-col">
          <div class="bg-gray-50 mb-4 p-4 rounded">
            <div class="flex justify-between">
              <div>
                <p class="font-medium text-gray-700">–ü—Ä–æ—Ñ–∏–ª—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞:</p>
                <p id="personaDisplay" class="mt-1 text-sm"></p>
              </div>
              <div>
                <p class="font-medium text-gray-700">–ù–∞–≤—ã–∫:</p>
                <p id="skillDisplay" class="mt-1 text-sm"></p>
              </div>
            </div>
          </div>
          <div id="connection-status" class="bg-yellow-100 p-2 rounded text-yellow-700 text-center mb-2">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
          <div id="messages" class="flex-1 mb-4 p-4 border h-80 overflow-y-auto"></div>
          <form id="chat-form" class="flex space-x-2 mb-4" onsubmit="sendMessage(event)">
            <input type="text" id="messageText" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" class="flex-grow p-2 border rounded" disabled />
            <button type="submit" class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded text-white" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
          </form>
          <div class="flex justify-between space-x-2">
            <button id="endInterviewBtn" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded text-white">–ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤—å—é</button>
            <span id="recordingStatus" class="text-gray-600"></span>
            <button id="recordButton" class="bg-blue-600 hover:bg-red-600 px-4 py-2 rounded text-white" disabled>–ó–∞–ø–∏—Å–∞—Ç—å –≥–æ–ª–æ—Å</button>
          </div>
        </div>
      </section>

      <!-- –ó–∞–≥–ª—É—à–∫–∏ –¥–ª—è –¥—Ä—É–≥–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ -->
      <section id="view-evaluation" class="view" style="display:none">
        <h1>–û—Ü–µ–Ω–∫–∞ –∏–Ω—Ç–µ—Ä–≤—å—é (–∑–∞–≥–ª—É—à–∫–∞)</h1>
      </section>
      <section id="view-newprofession" class="view" style="display:none">
        <h1>–£–∑–Ω–∞—Ç—å –æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏ (–∑–∞–≥–ª—É—à–∫–∞)</h1>
      </section>
    </div>
  </div>

  <script>
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–æ–≤
    function showView(id) {
      document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
      document.getElementById(id).style.display = '';
    }
    document.getElementById('btnInterview').onclick = () => showView('view-interview-form');
    document.getElementById('btnEvaluate').onclick = () => showView('view-evaluation');
    document.getElementById('btnProfession').onclick = () => showView('view-newprofession');
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –ø—Ä–æ—Ñ–∏–ª—è
    document.getElementById('personaForm').onsubmit = e => {
      e.preventDefault();
      const p = document.getElementById('inputPersona').value.trim();
      const s = document.getElementById('inputSkill').value.trim();
      document.getElementById('personaDisplay').textContent = p;
      document.getElementById('skillDisplay').textContent = s;
      showView('view-interview-chat');
      initInterview(p, s);
    };
    // –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ–º–∞—à–Ω–∏–π —ç–∫—Ä–∞–Ω
    showView('view-home');
  </script>

  <!-- –õ–æ–≥–∏–∫–∞ –∏–Ω—Ç–µ—Ä–≤—å—é (WebSocket, —Ñ—É–Ω–∫—Ü–∏–∏) -->
  <script>
    let ws, isConnected = false, isWaitingForResponse = false, mediaRecorder, audioChunks = [];
    let conversationHistory = [];
    function initInterview(persona, skill) {
      connectWebSocket(persona, skill);
    }
    function connectWebSocket(persona, skill) {
      const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
      const wsUrl = `${protocol}://${location.host}/ws/interview?persona=${encodeURIComponent(persona)}&skill=${encodeURIComponent(skill)}`;
      ws = new WebSocket(wsUrl);
      updateConnectionStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...', 'yellow');
      ws.onopen = () => { isConnected=true; updateConnectionStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ','green'); enableInterface(); };
      ws.onclose = e => { isConnected=false; disableInterface(); updateConnectionStatus('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ','yellow'); };
      ws.onerror = () => updateConnectionStatus('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è','red');
      ws.onmessage = event => handleWebSocketMessage(event);
    }
    function handleWebSocketMessage(event) {
      const resp = JSON.parse(event.data);
      if (resp.type==='error') return updateConnectionStatus(resp.text,'red');
      if (['text','voice'].includes(resp.type)) {
        addAssistantMessage(resp.content);
        if (resp.type==='voice' && resp.audio) playAudio(resp.audio);
        updateChatDisplay(); hideStatusMessage(); isWaitingForResponse=false; enableInterface();
      }
    }
    function sendMessage(e) {
      e.preventDefault(); if(!isConnected||isWaitingForResponse) return;
      const input = document.getElementById('messageText'); const msg = input.value.trim(); if(!msg) return;
      addUserMessage(msg); updateChatDisplay(); ws.send(JSON.stringify({type:'text',message:msg}));
      input.value=''; isWaitingForResponse=true; disableInterface(true);
    }
    function addUserMessage(txt){ conversationHistory.push({role:'user',content:txt}); }
    function addAssistantMessage(txt){ conversationHistory.push({role:'assistant',content:txt}); }
    function updateChatDisplay(){
      const el = document.getElementById('messages'); el.innerHTML='';
      conversationHistory.forEach(m=>{
        const d=document.createElement('div');
        d.textContent = (m.role==='user'?'üë§ ':'ü§ñ ')+m.content;
        d.style.textAlign = m.role==='user'?'right':'left'; el.appendChild(d);
      }); el.scrollTop=el.scrollHeight;
    }
    function updateConnectionStatus(msg,color){
      const st=document.getElementById('connection-status'); st.textContent=msg; st.className=`mb-2 p-2 text-center rounded bg-${color}-100 text-${color}-700`;
    }
    function hideStatusMessage(){ document.getElementById('connection-status').style.display='none'; }
    function enableInterface(){ document.getElementById('messageText').disabled=false; document.querySelector('#chat-form button').disabled=false; document.getElementById('recordButton').disabled=false; }
    function disableInterface(){ document.getElementById('messageText').disabled=true; document.querySelector('#chat-form button').disabled=true; document.getElementById('recordButton').disabled=true; }
    function playAudio(base64){ const a=new Audio('data:audio/mp3;base64,'+base64); a.play(); }
    document.getElementById('endInterviewBtn').onclick = ()=>{ ws.close(); showView('view-home'); };
    document.getElementById('recordButton').onclick = ()=>{/* recording logic here if needed */};
  </script>
</body>
</html>
