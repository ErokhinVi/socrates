<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Raiffeisen Bank Chat</title>

  <link rel="stylesheet" href="/static/style.css" />
  <!-- Markdown‚Äë–ø–∞—Ä—Å–µ—Ä -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <div class="container">
    <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  SIDEBAR  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <aside class="sidebar">
      <div class="logo-header">
        <img src="/static/images/raif_logo.png" alt="Raiffeisen Logo" class="header-icon" />
      </div>

      <div class="sidebar-buttons">
        <button id="btnInterview"  class="sidebar-btn">–ü—Ä–æ–≤–µ—Å—Ç–∏ –∏–Ω—Ç–µ—Ä–≤—å—é</button>
        <!-- –ö–Ω–æ–ø–∫–∞ "–û—Ü–µ–Ω–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤—å—é" —É–¥–∞–ª–µ–Ω–∞ -->
        <button id="btnProfession" class="sidebar-btn">–£–∑–Ω–∞—Ç—å –æ&nbsp;–ø—Ä–æ—Ñ–µ—Å—Å–∏–∏</button>
      </div>
    </aside>

    <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  MAIN CONTENT  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <main class="main-content">

      <!-- –î–æ–º–∞—à–Ω–∏–π —ç–∫—Ä–∞–Ω -->
      <section id="view-home" class="view">
        <div class="home-welcome">
          <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤¬†Raiffeisen¬†Hiring Simulator.</h1>
          <p>–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å.</p>
        </div>
      </section>

      <!-- –§–æ—Ä–º–∞ –ø—Ä–æ—Ñ–∏–ª—è –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ -->
      <section id="view-interview-form" class="view" style="display:none;">
        <div class="card">
          <h2 class="card-title">–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞</h2>
          <form id="personaForm" class="form-column">
            <label>
              <span class="label-text">–ü—Ä–æ—Ñ–∏–ª—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞:</span>
              <input type="text" id="inputPersona" placeholder="Data Scientist" required />
            </label>

            <label>
              <span class="label-text">–í—ã–¥–µ–ª–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞:</span>
              <input type="text" id="inputSkill" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä - –ø—Ä–æ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, —Ç–∞–π–º –º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç, –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å..." required />
            </label>

            <button type="submit" class="primary-btn w-full">–ü–µ—Ä–µ–π—Ç–∏ –∫ –∏–Ω—Ç–µ—Ä–≤—å—é</button>
          </form>
        </div>
      </section>

      <!-- –ß–∞—Ç –∏–Ω—Ç–µ—Ä–≤—å—é -->
      <section id="view-interview-chat" class="view" style="display:none;">
        <div class="chat-area">
            <div class="chat-info">
                <h2 class="chat-heading">–¢–µ–∫—É—â–∞—è —Å–µ—Å—Å–∏—è –∏–Ω—Ç–µ—Ä–≤—å—é</h2>
              
                <!-- flex‚Äë–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –º–µ—Ç–∞‚Äë–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ -->
                <div class="chat-meta">
                  <div class="meta-item">
                    <strong>–ü—Ä–æ—Ñ–∏–ª—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞:</strong>
                    <span id="personaDisplay"></span>
                  </div>
                  <div class="meta-item">
                    <strong>–ö–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏:</strong>
                    <span id="skillDisplay"></span>
                  </div>
                </div>
              </div>

          <div id="connection-status" class="status-toast hidden"></div>

          <div id="messages" class="messages"></div>

          <form id="chat-form" class="input-area" onsubmit="sendMessage(event)">
            <input type="text" id="messageText" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" disabled />
            <button type="submit" id="send-btn" disabled>
              <img src="/static/icons/send.svg" alt="–û—Ç–ø—Ä–∞–≤–∏—Ç—å" />
            </button>
          </form>

          <div class="chat-actions">
            <button id="endInterviewBtn" class="primary-btn">–ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤—å—é</button>
            <button id="recordButton"  class="primary-btn secondary" disabled>–ó–∞–ø–∏—Å–∞—Ç—å –≥–æ–ª–æ—Å</button>
          </div>
        </div>
      </section>

      <!-- –≠–∫—Ä–∞–Ω –æ—Ü–µ–Ω–∫–∏ (STAR)  ‚îÄ‚îÄ‚îÄ –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –Ω–æ –æ—Å—Ç–∞–≤–ª–µ–Ω
           –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ -->
      <section id="view-evaluation" class="view" style="display:none;">
        <div class="card">
          <h2 class="card-title">–û—Ü–µ–Ω–∫–∞ –∏–Ω—Ç–µ—Ä–≤—å—é (–º–µ—Ç–æ–¥ STAR)</h2>
          <p>–ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞ —Ç–µ–ø–µ—Ä—å –≤—ã–≤–æ–¥–∏—Ç—Å—è –ø—Ä—è–º–æ –≤ —á–∞—Ç–µ üòä</p>
          <button id="evalBackBtn" class="primary-btn mt-4">–ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
        </div>
      </section>

      <!-- –≠–∫—Ä–∞–Ω ¬´–£–∑–Ω–∞—Ç—å –æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏¬ª -->
      <section id="view-newprofession" class="view" style="display:none;">
        <div class="card">
          <h2 class="card-title">–£–∑–Ω–∞—Ç—å –æ¬†–ø—Ä–æ—Ñ–µ—Å—Å–∏–∏</h2>
          <p>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ¬†–ø—Ä–æ—Ñ–µ—Å—Å–∏–∏‚Ä¶</p>
        </div>
      </section>

    </main>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  JS  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <script>
    /* ---------- –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–æ–≤ ---------- */
    function showView(id) {
      document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
      document.getElementById(id).style.display = '';
    }

    // –û–±—ä–µ–∫—Ç –∫–Ω–æ–ø–æ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ ‚Äî –∫–Ω–æ–ø–∫–∞ –æ—Ü–µ–Ω–∫–∏ –∏–Ω—Ç–µ—Ä–≤—å—é —É–¥–∞–ª–µ–Ω–∞
    const buttons = {
      btnInterview:  'view-interview-form',
      // btnEvaluate:   'view-evaluation', // —É–¥–∞–ª–µ–Ω–æ
      btnProfession: 'view-newprofession',
    };

    Object.entries(buttons).forEach(([btn, view]) => {
      const el = document.getElementById(btn);
      if (el) el.onclick = () => showView(view);
    });

    // –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∏–∑ —ç–∫—Ä–∞–Ω–∞ –æ—Ü–µ–Ω–∫–∏
    document.getElementById('evalBackBtn').onclick = () => showView('view-home');

    /* ---------- —Ñ–æ—Ä–º–∞ –ø—Ä–æ—Ñ–∏–ª—è ---------- */
    document.getElementById('personaForm').onsubmit = e => {
      e.preventDefault();
      const persona = document.getElementById('inputPersona').value.trim();
      const skill   = document.getElementById('inputSkill').value.trim();
      document.getElementById('personaDisplay').textContent = persona;
      document.getElementById('skillDisplay').textContent   = skill;
      showView('view-interview-chat');
      initInterview(persona, skill);
    };

    // —Å—Ç–∞—Ä—Ç—É–µ–º —Å –¥–æ–º–∞—à–Ω–µ–≥–æ —ç–∫—Ä–∞–Ω–∞
    showView('view-home');

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  WebSocket‚Äë–ª–æ–≥–∏–∫–∞  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    let ws,
        isConnected = false,
        isWaitingForResponse = false,
        mediaRecorder, audioChunks = [],
        conversationHistory = [];

    function initInterview(persona, skill) {
      connectWebSocket(persona, skill);
    }

    function connectWebSocket(persona, skill) {
      const proto = location.protocol === 'https:' ? 'wss' : 'ws';
      const url   = `${proto}://${location.host}/ws/interview?persona=${encodeURIComponent(persona)}&skill=${encodeURIComponent(skill)}`;

      ws = new WebSocket(url);
      updateConnectionStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ‚Ä¶', 'yellow');

      ws.onopen    = () => {
        isConnected = true;
        updateConnectionStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ', 'green');
        setTimeout(hideStatusMessage, 1000);
        enableInterface();
      };
      ws.onmessage = handleWebSocketMessage;
      ws.onerror   = () => updateConnectionStatus('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'red');
      ws.onclose   = () => {
        isConnected = false;
        updateConnectionStatus('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ', 'yellow');
      };
    }

    function handleWebSocketMessage(event) {
      const resp = JSON.parse(event.data);

      if (resp.type === 'error') {
        return updateConnectionStatus(resp.text, 'red');
      }

      /* ---------- –æ–±—ã—á–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ ---------- */
      if (['text', 'voice'].includes(resp.type)) {
        addAssistantMessage(resp.content);
        if (resp.type === 'voice' && resp.audio) playAudio(resp.audio);
        updateChatDisplay();
        hideStatusMessage();
        isWaitingForResponse = false;
        enableInterface();
        return;
      }

      /* ---------- –∏—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞ STAR ---------- */
      if (resp.type === 'star_summary') {
        const s = resp.star || {};
        const md = [
          '**üìä –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞ (–º–µ—Ç–æ–¥¬†STAR)**',
          '',
          `**Situation:**\n${s.Situation || s.S || '‚Äî'}`,
          '',
          `**Task:**\n${s.Task || s.T || '‚Äî'}`,
          '',
          `**Action:**\n${s.Action || s.A || '‚Äî'}`,
          '',
          `**Result:**\n${s.Result || s.R || '‚Äî'}`,
        ].join('\n');
        addAssistantMessage(md);
        updateChatDisplay();
        disableInterface();
        if (ws) ws.close(1000, 'Interview finished');
      }
    }

    function sendMessage(e) {
      e.preventDefault();
      if (!isConnected || isWaitingForResponse) return;

      const input = document.getElementById('messageText');
      const msg   = input.value.trim();
      if (!msg) return;

      addUserMessage(msg);
      updateChatDisplay();

      ws.send(JSON.stringify({ type: 'text', message: msg }));

      input.value          = '';
      isWaitingForResponse = true;
      disableInterface();
    }

    document.getElementById('endInterviewBtn').onclick = () => {
      if (!isConnected) { showView('view-home'); return; }

      disableInterface();
      isWaitingForResponse = true;
      updateConnectionStatus('–§–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –∏—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞‚Ä¶', 'yellow');

      ws.send(JSON.stringify({ type: 'end' }));
    };

    /* ---------- –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---------- */
    function addUserMessage(txt)      { conversationHistory.push({ role: 'user',      content: txt }); }
    function addAssistantMessage(txt) { conversationHistory.push({ role: 'assistant', content: txt }); }

    function updateChatDisplay() {
      const el = document.getElementById('messages');
      el.innerHTML = '';
      conversationHistory.forEach(m => {
        const d = document.createElement('div');
        if (m.role === 'assistant') {
          d.className = 'message-assistant';
          d.innerHTML = marked.parse(m.content);
        } else {
          d.className = 'message-user';
          d.textContent = m.content;
        }
        el.appendChild(d);
      });
      el.scrollTop = el.scrollHeight;     /* –∞–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –≤–Ω–∏–∑ */
    }

    function updateConnectionStatus(msg, color) {
      const st = document.getElementById('connection-status');
      const map = { yellow:'bg-yellow', green:'bg-green', red:'bg-red' };
      st.className = `status-toast ${map[color] || 'bg-yellow'}`;
      st.textContent = msg;
      st.classList.remove('hidden');
    }
    function hideStatusMessage()           { document.getElementById('connection-status').classList.add('hidden'); }
    function enableInterface()             { setInterfaceDisabled(false); }
    function disableInterface()            { setInterfaceDisabled(true); }
    function setInterfaceDisabled(state) {
      document.getElementById('messageText').disabled  = state;
      document.getElementById('send-btn').disabled     = state;
      document.getElementById('recordButton').disabled = state;
    }

    function playAudio(base64) {
      const audio = new Audio('data:audio/mp3;base64,' + base64);
      audio.play().catch(() => {});
    }

    /* ------------- –ø—Ä–µ–∂–Ω—è—è —Ñ—É–Ω–∫—Ü–∏—è renderStarEvaluation
       –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–∞, –Ω–æ –æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –Ω–∞ —Å–ª—É—á–∞–π –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ ---------- */
    function renderStarEvaluation() {}

    document.getElementById('recordButton').onclick = () => {
      /* –ª–æ–≥–∏–∫–∞ –∑–∞–ø–∏—Å–∏, –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ */
    };
  </script>
</body>
</html>
