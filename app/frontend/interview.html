<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ò–Ω—Ç–µ—Ä–≤—å—é</title>

    <!-- Tailwind + Typography plugin -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>

    <!-- Markdown parser & sanitizer -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.5.6/dist/purify.min.js"></script>
</head>
<body class="h-screen w-screen bg-[#2B2D33] font-sans">
    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø–æ–ª–Ω—è–µ—Ç –≤—Å—ë –æ–∫–Ω–æ -->
    <div class="flex flex-col h-full w-full p-6 bg-white overflow-hidden">
        <!-- –¢–µ–∫—É—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–Ω—Ç–µ—Ä–≤—å—é -->
        <div class="p-2 mb-4 bg-gray-50 rounded">
            <h2 class="mb-2 text-lg font-semibold">–¢–µ–∫—É—â–∞—è —Å–µ—Å—Å–∏—è –∏–Ω—Ç–µ—Ä–≤—å—é</h2>
            <div class="flex gap-4">
                <div class="flex-1">
                    <p class="text-sm font-medium text-gray-700">–ü—Ä–æ—Ñ–∏–ª—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞:</p>
                    <p id="personaDisplay" class="mt-1 text-sm">{{ persona if persona else "Not specified" }}</p>
                </div>
                <div class="flex-1">
                    <p class="text-sm font-medium text-gray-700">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</p>
                    <p id="skillDisplay" class="mt-1 text-sm">{{ skill if skill else "Not specified" }}</p>
                </div>
            </div>
        </div>

        <!-- –°—Ç–∞—Ç—É—Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è -->
        <div id="connection-status" class="p-2 mb-2 text-center text-yellow-700 bg-yellow-100 rounded">
            –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...
        </div>

        <!-- –°–æ–æ–±—â–µ–Ω–∏—è –∏ STAR‚Äë–æ—Ü–µ–Ω–∫–∏ -->
        <div id="messages" class="flex-grow w-full max-w-none p-4 overflow-y-auto break-words border prose prose-sm"></div>

        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞ -->
        <div id="waitingIndicator" class="flex items-center justify-center my-2 hidden">
            <svg class="w-5 h-5 text-blue-600 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4l5-5-5-5v4a10 10 0 00-5 18.9V20a8 8 0 010-16z"></path>
            </svg>
            <span class="ml-2 text-sm text-gray-700">–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–µ—á–∞—Ç–∞–µ—Ç...</span>
        </div>

        <!-- –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞ -->
        <form id="chat-form" onsubmit="sendMessage(event)" class="flex space-x-2">
            <textarea
                id="messageText"
                placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (Ctrl+Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å)"
                rows="3"
                class="flex-grow p-2 border rounded resize-y"
                disabled
            ></textarea>
            <button type="submit" class="px-4 py-2 text-white bg-blue-500 rounded hover:bg-blue-600" disabled>
                –û—Ç–ø—Ä–∞–≤–∏—Ç—å
            </button>
        </form>

        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–≤—å—é –∏ –∑–∞–ø–∏—Å—å—é -->
        <div class="flex justify-between mt-4 space-x-2">
            <button
                id="endInterviewBtn"
                onclick="endInterview()"
                class="px-4 py-2 text-white bg-red-600 rounded hover:bg-red-700"
            >
                –ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤—å—é
            </button>
            <span id="recordingStatus" class="text-gray-600"></span>
            <button
                id="recordButton"
                onclick="toggleRecording()"
                class="px-4 py-2 text-white bg-blue-600 rounded hover:bg-red-600"
                disabled
            >
                –ó–∞–ø–∏—Å–∞—Ç—å –≥–æ–ª–æ—Å
            </button>
        </div>
    </div>

    <script>
        /* -------------------- –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Å–µ—Å—Å–∏–∏ -------------------- */
        const urlParams = new URLSearchParams(window.location.search);
        const currentPersona = urlParams.get("persona");
        const currentSkill = urlParams.get("skill");
        if (!currentPersona || !currentSkill) window.location.href = "/select-persona";
        document.getElementById("personaDisplay").textContent = currentPersona;
        document.getElementById("skillDisplay").textContent = currentSkill;

        /* -------------------- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ -------------------- */
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let isConnected = false;
        let isWaitingForResponse = false;
        let ws; // WebSocket

        // –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç STAR)
        const conversationHistory = {
            timestamp: new Date().toISOString(),
            persona: currentPersona,
            skill: currentSkill,
            messages: []
        };

        /* -------------------- –£—Ç–∏–ª–∏—Ç—ã -------------------- */
        const isNonEmptyObject = obj => obj && Object.keys(obj).length > 0;

        /* -------------------- WebSocket -------------------- */
        function connectWebSocket() {
            const wsHost = window.location.host || "localhost:8000";
            const wsProtocol = window.location.protocol === "https:" ? "wss" : "ws";
            const wsUrl = `${wsProtocol}://${wsHost}/ws/interview?persona=${encodeURIComponent(currentPersona)}&skill=${encodeURIComponent(currentSkill)}`;
            ws = new WebSocket(wsUrl);
            updateConnectionStatus("–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...", "yellow");

            ws.onopen = () => {
                isConnected = true;
                updateConnectionStatus("–ü–æ–¥–∫–ª—é—á–µ–Ω–æ", "green");
                enableInterface();
            };
            ws.onclose = evt => {
                isConnected = false;
                disableInterface();
                if (evt.code === 1000) updateConnectionStatus("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ", "yellow");
                else {
                    updateConnectionStatus("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ", "red");
                    showError("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.");
                }
            };
            ws.onerror = () => updateConnectionStatus("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è", "red");
            ws.onmessage = handleWebSocketMessage;
        }

        function handleWebSocketMessage(event) {
            try {
                const response = JSON.parse(event.data);
                if (response.type === "error") {
                    showError(`–û—à–∏–±–∫–∞: ${response.text}`);
                    hideWaitingIndicator();
                    resetWaitingState();
                    return;
                }
                if (["text", "voice"].includes(response.type)) {
                    processMessage(response);
                    updateChatDisplay();
                    hideStatusMessage();
                    hideWaitingIndicator();
                    resetWaitingState();
                }
            } catch {
                showError("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è");
                hideWaitingIndicator();
                resetWaitingState();
            }
        }

        /* -------------------- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ -------------------- */
        function processMessage(response) {
            if (response.type === "voice" && response.user_text) addUserMessage(response.user_text);

            if (response.content?.trim()) {
                addAssistantMessage(response.content, response.star || null);

                // –ê—É–¥–∏–æ, –µ—Å–ª–∏ –µ—Å—Ç—å
                if (response.type === "voice" && response.audio) playAudio(response.audio);
            }
        }

        /* -------------------- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∏—Å—Ç–æ—Ä–∏—é -------------------- */
        function addUserMessage(content) {
            const lastUserMsg = getLastMessageByRole("user");
            if (!lastUserMsg || lastUserMsg.content !== content) {
                conversationHistory.messages.push({ role: "user", content });
            }
        }

        function addAssistantMessage(content, star = null) {
            const lastAssistantMsg = getLastMessageByRole("assistant");
            if (!lastAssistantMsg || lastAssistantMsg.content !== content) {
                const msgObj = { role: "assistant", content };
                if (isNonEmptyObject(star)) msgObj.star = star;
                conversationHistory.messages.push(msgObj);
            }
        }

        function getLastMessageByRole(role) {
            return conversationHistory.messages.filter(m => m.role === role).pop();
        }

        function resetWaitingState() {
            isWaitingForResponse = false;
            enableInterface();
        }
        function hideStatusMessage() {
            updateConnectionStatus("", "");
        }

        /* -------------------- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π -------------------- */
        function renderMarkdown(text) {
            const unsafeHtml = marked.parse(text || "");
            return DOMPurify.sanitize(unsafeHtml);
        }

        function updateChatDisplay() {
            const messagesEl = document.getElementById("messages");
            messagesEl.innerHTML = "";

            conversationHistory.messages.forEach(msg => {
                const wrapper = document.createElement("div");
                wrapper.className = "mb-4";
                wrapper.classList.add(msg.role === "user" ? "text-right" : "text-left");

                const roleLabel = document.createElement("p");
                roleLabel.className = "font-semibold mb-1";
                roleLabel.textContent = msg.role === "user" ? "Ôºªüë§ÔºΩ:" : "Ôºªü§ñÔºΩ:";
                wrapper.appendChild(roleLabel);

                const contentBlock = document.createElement("div");
                contentBlock.innerHTML = renderMarkdown(msg.content);
                wrapper.appendChild(contentBlock);

                messagesEl.appendChild(wrapper);

                if (isNonEmptyObject(msg.star)) {
                    messagesEl.appendChild(renderStarEvaluation(msg.star));
                }
            });

            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function renderStarEvaluation(starObj) {
            const container = document.createElement("div");
            container.className = "p-3 mb-4 ml-6 text-sm text-gray-800 bg-indigo-50 rounded";

            const title = document.createElement("p");
            title.className = "mb-1 font-semibold";
            title.textContent = "STAR –æ—Ü–µ–Ω–∫–∞:";
            container.appendChild(title);

            ["Situation", "Task", "Action", "Result"].forEach(key => {
                if (starObj[key] !== undefined) {
                    const row = document.createElement("p");
                    row.innerHTML = `<strong>${key}:</strong> ${renderMarkdown(starObj[key])}`;
                    container.appendChild(row);
                }
            });

            return container;
        }

        function showError(msg) {
            const st = document.getElementById("connection-status");
            st.textContent = msg;
            st.className = "p-2 mb-2 text-center text-red-700 bg-red-100 rounded";
            st.classList.remove("hidden");
        }

        /* -------------------- –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è -------------------- */
        function sendMessage(evt) {
            evt.preventDefault();
            if (!isConnected || isWaitingForResponse) return;

            const input = document.getElementById("messageText");
            const userMsg = input.value.trim();
            if (!userMsg) return;

            addUserMessage(userMsg);
            updateChatDisplay();

            try {
                ws.send(JSON.stringify({ type: "text", message: userMsg }));
                input.value = "";
                isWaitingForResponse = true;
                disableInterface(true);
                showWaitingIndicator();
            } catch {
                showError("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è");
                hideWaitingIndicator();
            }
        }

        /* -------------------- –ê—É–¥–∏–æ -------------------- */
        function playAudio(base64Audio) {
            if (!base64Audio) return;
            try {
                const audio = new Audio("data:audio/mp3;base64," + base64Audio);
                audio.play().catch(err => showError("–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∞—É–¥–∏–æ: " + err.message));
            } catch (err) {
                showError("–û—à–∏–±–∫–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∞—É–¥–∏–æ: " + err.message);
            }
        }

        /* -------------------- –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–≤—å—é -------------------- */
        function endInterview() {
            if (!conversationHistory.messages.length) {
                alert("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è. –ü—Ä–æ–≤–µ–¥–∏—Ç–µ –∏–Ω—Ç–µ—Ä–≤—å—é.");
                return;
            }
            if (!confirm("–ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤—å—é –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã?")) return;

            try {
                exportInterviewData();
                closeConnection();
                redirectToHome();
            } catch (err) {
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: " + err.message);
            }
        }

        function exportInterviewData() {
            const interviewData = {
                timestamp: new Date().toISOString(),
                persona: currentPersona,
                skill: currentSkill,
                messages: conversationHistory.messages
            };
            if (!interviewData.messages.length) throw new Error("–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");

            const blob = new Blob([JSON.stringify(interviewData, null, 2)], { type: "application/json" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `interview_${currentPersona.replace(/[^a-zA-Z–∞-—è–ê-–Ø0-9]/g, "_").substring(0, 20)}_${new Date().toISOString().replace(/[:.]/g, "-")}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        }

        function closeConnection() {
            if (ws?.readyState === WebSocket.OPEN) ws.close(1000, "Interview completed");
        }
        function redirectToHome() {
            setTimeout(() => location.href = "/", 1000);
        }

        /* -------------------- –ó–∞–ø–∏—Å—å –∞—É–¥–∏–æ -------------------- */
        async function toggleRecording() {
            if (!isConnected || isWaitingForResponse) return;
            isRecording ? stopRecording() : startRecording();
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = processRecordedAudio;
                mediaRecorder.start();
                isRecording = true;
                updateRecordingUI(true);
            } catch {
                showError("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É");
            }
        }

        function stopRecording() {
            mediaRecorder.stop();
            mediaRecorder.stream.getTracks().forEach(t => t.stop());
            isRecording = false;
            updateRecordingUI(false);
        }

        async function processRecordedAudio() {
            try {
                const blob = new Blob(audioChunks, { type: "audio/webm" });
                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64Audio = reader.result.split(",")[1];
                    sendAudioToServer(base64Audio);
                };
                reader.readAsDataURL(blob);
            } catch {
                showError("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞—É–¥–∏–æ");
            }
        }

        function sendAudioToServer(b64) {
            try {
                ws.send(JSON.stringify({ type: "audio", audio: b64, format: "webm" }));
                updateConnectionStatus("–ê—É–¥–∏–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ, –æ–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞...", "yellow");
                isWaitingForResponse = true;
                disableInterface(true);
                showWaitingIndicator();
            } catch {
                showError("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞—É–¥–∏–æ");
                hideWaitingIndicator();
            }
        }

        /* -------------------- UI helpers -------------------- */
        function updateRecordingUI(active) {
            const btn = document.getElementById("recordButton");
            const status = document.getElementById("recordingStatus");

            if (active) {
                btn.textContent = "–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å";
                btn.classList.replace("bg-blue-600", "bg-red-600");
                status.textContent = "–ó–∞–ø–∏—Å—å...";
                document.getElementById("messageText").disabled = true;
                document.querySelector("#chat-form button").disabled = true;
            } else {
                btn.textContent = "–ó–∞–ø–∏—Å–∞—Ç—å –≥–æ–ª–æ—Å";
                btn.classList.replace("bg-red-600", "bg-blue-600");
                status.textContent = "";
                document.getElementById("messageText").disabled = false;
                document.querySelector("#chat-form button").disabled = false;
            }
        }

        // ********************** WAITING INDICATOR helper functions **********************
        function showWaitingIndicator() {
            document.getElementById("waitingIndicator").classList.remove("hidden");
        }
        function hideWaitingIndicator() {
            document.getElementById("waitingIndicator").classList.add("hidden");
        }
        // ********************************************************************************

        function updateConnectionStatus(msg, color) {
            const el = document.getElementById("connection-status");
            if (!msg) {
                el.classList.add("hidden");
                return;
            }

            el.textContent = msg;
            el.className = "p-2 mb-2 text-center rounded";
            el.classList.remove("hidden");

            const colors = {
                green: ["bg-green-100", "text-green-700"],
                yellow: ["bg-yellow-100", "text-yellow-700"],
                red: ["bg-red-100", "text-red-700"]
            };
            if (colors[color]) el.classList.add(...colors[color]);

            if (color === "green") setTimeout(() => el.classList.add("hidden"), 2000);
        }

        function enableInterface() {
            setInterfaceState(false);
        }
        function disableInterface() {
            setInterfaceState(true);
        }
        function setInterfaceState(disabled) {
            ["messageText", "#chat-form button", "recordButton"].forEach(sel => {
                const el = sel.startsWith("#") ? document.querySelector(sel) : document.getElementById(sel);
                if (el) el.disabled = disabled;
            });
            if (!disabled) document.getElementById("messageText").focus();
        }

        /* -------------------- –î–æ–ø. –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏—à -------------------- */
        // Ctrl (–∏–ª–∏ Cmd) + Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ, Enter –±–µ–∑ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ ‚Äî –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏
        document.getElementById("messageText").addEventListener("keydown", e => {
            if (e.key === "Enter" && (e.ctrlKey || e.metaKey)) {
                e.preventDefault();
                document.getElementById("chat-form").requestSubmit();
            }
        });

        /* -------------------- Init -------------------- */
        connectWebSocket();
    </script>
</body>
</html>
