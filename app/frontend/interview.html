<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ò–Ω—Ç–µ—Ä–≤—å—é</title>

    <!-- Tailwind + Typography -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>

    <!-- Markdown¬†parser¬†+ sanitizer -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.5.6/dist/purify.min.js"></script>
</head>
<body class="h-screen w-screen bg-[#2B2D33] font-sans">
    <div class="flex flex-col h-full w-full p-6 bg-white overflow-hidden">

        <!-- —Ç–µ–∫—É—â–∞—è —Å–µ—Å—Å–∏—è -->
        <div class="p-2 mb-4 bg-gray-50 rounded">
            <h2 class="mb-2 text-lg font-semibold">–¢–µ–∫—É—â–∞—è —Å–µ—Å—Å–∏—è –∏–Ω—Ç–µ—Ä–≤—å—é</h2>
            <div class="flex gap-4">
                <div class="flex-1">
                    <p class="text-sm font-medium text-gray-700">–ü—Ä–æ—Ñ–∏–ª—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞:</p>
                    <p id="personaDisplay" class="mt-1 text-sm break-words"></p>
                </div>
                <div class="flex-1">
                    <p class="text-sm font-medium text-gray-700">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</p>
                    <p id="skillDisplay" class="mt-1 text-sm break-words"></p>
                </div>
            </div>
        </div>

        <!-- —Å—Ç–∞—Ç—É—Å -->
        <div id="connection-status" class="p-2 mb-2 text-center text-yellow-700 bg-yellow-100 rounded">
            –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...
        </div>

        <!-- —Å–æ–æ–±—â–µ–Ω–∏—è -->
        <div id="messages" class="flex-grow w-full max-w-none p-4 overflow-y-auto break-words border prose prose-sm"></div>

        <!-- –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏ -->
        <div id="waitingIndicator" class="flex items-center justify-center my-2 hidden">
            <svg class="w-5 h-5 text-blue-600 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4l5-5-5-5v4a10 10 0 00-5 18.9V20a8 8 0 010-16z"></path>
            </svg>
            <span class="ml-2 text-sm text-gray-700">–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–µ—á–∞—Ç–∞–µ—Ç...</span>
        </div>

        <!-- —Ñ–æ—Ä–º–∞ –≤–≤–æ–¥–∞ -->
        <form id="chat-form" onsubmit="sendMessage(event)" class="flex space-x-2">
            <textarea
                id="messageText"
                placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (Ctrl+Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å)"
                rows="3"
                class="flex-grow p-2 border rounded resize-y"
                disabled
            ></textarea>
            <button type="submit" class="px-4 py-2 text-white bg-blue-500 rounded hover:bg-blue-600" disabled>
                –û—Ç–ø—Ä–∞–≤–∏—Ç—å
            </button>
        </form>

        <!-- –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è -->
        <div id="preEndControls" class="flex justify-between mt-4 space-x-2">
            <button
                id="endInterviewBtn"
                onclick="endInterview()"
                class="px-4 py-2 text-white bg-red-600 rounded hover:bg-red-700"
            >
                –ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤—å—é
            </button>
            <span id="recordingStatus" class="text-gray-600"></span>
            <button
                id="recordButton"
                onclick="toggleRecording()"
                class="px-4 py-2 text-white bg-blue-600 rounded hover:bg-red-600"
                disabled
            >
                –ó–∞–ø–∏—Å–∞—Ç—å –≥–æ–ª–æ—Å
            </button>
        </div>

        <!-- –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è -->
        <div id="postEndControls" class="flex justify-end mt-4 space-x-2 hidden">
            <button
                id="downloadBtn"
                class="px-4 py-2 text-white bg-green-600 rounded hover:bg-green-700"
            >
                –°–∫–∞—á–∞—Ç—å –æ—Ç—á—ë—Ç
            </button>
            <button
                id="closeBtn"
                class="px-4 py-2 text-white bg-gray-600 rounded hover:bg-gray-700"
            >
                –ó–∞–∫—Ä—ã—Ç—å —Å–µ—Å—Å–∏—é
            </button>
        </div>
    </div>

<script>
/* ---------- –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL ---------- */
const params = new URLSearchParams(window.location.search);
const currentPersona = params.get("persona");
const currentSkill   = params.get("skill");
if (!currentPersona || !currentSkill) location.href = "/select-persona";
document.getElementById("personaDisplay").textContent = currentPersona;
document.getElementById("skillDisplay").textContent   = currentSkill;

/* ---------- –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ---------- */
let ws, mediaRecorder, isRecording = false, isWaiting = false, interviewEnded = false;
let conversationHistory = {
    timestamp: new Date().toISOString(),
    persona: currentPersona,
    skill:   currentSkill,
    messages: []
};
let starSummary = null;

/* ---------- helpers ---------- */
const sanitize = html => DOMPurify.sanitize(marked.parse(html || ""));

function updateConnectionStatus(msg, color){
    const el = document.getElementById("connection-status");
    if (!msg){
        el.classList.add("hidden");
        return;
    }
    el.textContent = msg;
    el.className   = "p-2 mb-2 text-center rounded";
    el.classList.remove("hidden");
    const map = {
        green:["bg-green-100","text-green-700"],
        yellow:["bg-yellow-100","text-yellow-700"],
        red:["bg-red-100","text-red-700"]
    };
    if (map[color]) el.classList.add(...map[color]);
    if (color==="green") setTimeout(()=>el.classList.add("hidden"),2000);
}

function enableUI(disabled){
    ["messageText","#chat-form button","recordButton","endInterviewBtn"].forEach(sel=>{
        const el = sel.startsWith("#")?document.querySelector(sel):document.getElementById(sel);
        if (el) el.disabled = disabled;
    });
    if (!disabled) document.getElementById("messageText").focus();
}

function showWait(show){
    document.getElementById("waitingIndicator").classList.toggle("hidden", !show);
}

/* ---------- websocket ---------- */
function connect(){
    const proto = location.protocol==="https:"?"wss":"ws";
    ws = new WebSocket(`${proto}://${location.host}/ws/interview?persona=${encodeURIComponent(currentPersona)}&skill=${encodeURIComponent(currentSkill)}`);
    updateConnectionStatus("–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...","yellow");

    ws.onopen   = ()=>{ updateConnectionStatus("–ü–æ–¥–∫–ª—é—á–µ–Ω–æ","green"); enableUI(false); };
    ws.onclose  = ()=>{ if (!interviewEnded) updateConnectionStatus("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ","yellow"); enableUI(true); };
    ws.onerror  = ()=>{ updateConnectionStatus("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è","red"); enableUI(true); };
    ws.onmessage= onWSMessage;
}

function onWSMessage(evt){
    let data;
    try{ data = JSON.parse(evt.data); }catch{ return; }

    switch(data.type){
        case "text":
        case "voice":
            processAssistantMessage(data);
            break;
        case "star_summary":
            handleStarSummary(data.star);
            break;
        case "error":
            updateConnectionStatus(`–û—à–∏–±–∫–∞: ${data.text}`, "red");
            break;
    }
    showWait(false);
    isWaiting = false;
    if (!interviewEnded) enableUI(false);
}

function processAssistantMessage(data){
    if (data.type==="voice" && data.user_text) addMessage("user", data.user_text);
    addMessage("assistant", data.content);
    updateMessagesView();
    if (data.type==="voice" && data.audio) new Audio("data:audio/mp3;base64,"+data.audio).play();
}

/* ---------- —Å–æ–æ–±—â–µ–Ω–∏—è ---------- */
function addMessage(role, content){
    conversationHistory.messages.push({role,content});
}

function updateMessagesView(){
    const wrap = document.getElementById("messages");
    wrap.innerHTML="";
    conversationHistory.messages.forEach(m=>{
        const block=document.createElement("div");
        block.className="mb-4 "+(m.role==="user"?"text-right":"text-left");
        block.innerHTML=`<p class="font-semibold mb-1">Ôºª${m.role==="user"?"üë§":"ü§ñ"}ÔºΩ:</p><div>${sanitize(m.content)}</div>`;
        wrap.appendChild(block);
    });
    if (starSummary) renderStarSummary();  // –µ—Å–ª–∏ –æ—Ü–µ–Ω–∫–∞ —É–∂–µ –ø–æ–ª—É—á–µ–Ω–∞
    wrap.scrollTop = wrap.scrollHeight;
}

/* ---------- –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞ ---------- */
function sendMessage(e){
    e.preventDefault();
    if (isWaiting || interviewEnded) return;
    const txt = document.getElementById("messageText");
    const val = txt.value.trim();
    if (!val) return;
    addMessage("user", val);
    updateMessagesView();
    ws.send(JSON.stringify({type:"text", message:val}));
    txt.value="";
    isWaiting = true;
    enableUI(true);
    showWait(true);
}

/* ---------- –∞—É–¥–∏–æ ---------- */
async function toggleRecording(){
    if (isWaiting || interviewEnded) return;
    if (!isRecording) startRec(); else stopRec();
}

async function startRec(){
    try{
        const stream = await navigator.mediaDevices.getUserMedia({audio:true});
        mediaRecorder = new MediaRecorder(stream);
        const chunks=[];
        mediaRecorder.ondataavailable = e=>chunks.push(e.data);
        mediaRecorder.onstop = ()=>{
            const blob = new Blob(chunks,{type:"audio/webm"});
            const reader=new FileReader();
            reader.onloadend=()=>ws.send(JSON.stringify({type:"audio", audio:reader.result.split(",")[1]}));
            reader.readAsDataURL(blob);
            updateConnectionStatus("–ê—É–¥–∏–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ, –æ–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞...","yellow");
            isWaiting = true;
            enableUI(true);
            showWait(true);
        };
        mediaRecorder.start();
        isRecording = true;
        document.getElementById("recordButton").textContent = "–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å";
    }catch(err){
        updateConnectionStatus("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É","red");
    }
}

function stopRec(){
    mediaRecorder.stop();
    mediaRecorder.stream.getTracks().forEach(t=>t.stop());
    isRecording = false;
    document.getElementById("recordButton").textContent = "–ó–∞–ø–∏—Å–∞—Ç—å –≥–æ–ª–æ—Å";
}

/* ---------- –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–≤—å—é ---------- */
function endInterview(){
    if (!conversationHistory.messages.length){
        alert("–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ–¥–∏—Ç–µ –∏–Ω—Ç–µ—Ä–≤—å—é");
        return;
    }
    if (!confirm("–ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤—å—é –∏ –ø–æ–ª—É—á–∏—Ç—å –∏—Ç–æ–≥–æ–≤—É—é –æ—Ü–µ–Ω–∫—É?")) return;
    enableUI(true);
    updateConnectionStatus("–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤—É—é –æ—Ü–µ–Ω–∫—É‚Ä¶","yellow");
    ws.send(JSON.stringify({type:"end"}));
    showWait(true);
}

function handleStarSummary(star){
    interviewEnded = true;
    starSummary = star;
    renderStarSummary();
    disablePreEndUI();
    showPostEndUI();
    updateConnectionStatus("–ò–Ω—Ç–µ—Ä–≤—å—é –∑–∞–≤–µ—Ä—à–µ–Ω–æ","green");
}

function renderStarSummary(){
    if (!starSummary) return;
    const wrap=document.getElementById("messages");
    const box=document.createElement("div");
    box.className="p-3 mb-4 text-sm text-gray-800 bg-indigo-50 rounded";
    box.innerHTML="<p class='mb-2 font-semibold'>STAR‚Äë–æ—Ü–µ–Ω–∫–∞ (Situation / Task / Action / Result):</p>"+
        ["Situation","Task","Action","Result"].map(k=>
            starSummary[k]!==undefined?`<p><strong>${k}:</strong> ${sanitize(starSummary[k])}</p>`:""
        ).join("");
    wrap.appendChild(box);
    wrap.scrollTop = wrap.scrollHeight;
}

/* ---------- UI –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è ---------- */
function disablePreEndUI(){
    document.getElementById("preEndControls").classList.add("hidden");
    enableUI(true);
    document.getElementById("messageText").disabled = true;
}

function showPostEndUI(){
    const post = document.getElementById("postEndControls");
    post.classList.remove("hidden");
    document.getElementById("downloadBtn").addEventListener("click", downloadInterviewJson);
    document.getElementById("closeBtn").addEventListener("click", closeSession);
}

function downloadInterviewJson(){
    conversationHistory.star = starSummary;
    const blob = new Blob([JSON.stringify(conversationHistory,null,2)], {type:"application/json"});
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `interview_${currentPersona.replace(/[^a-zA-Z–∞-—è–ê-–Ø0-9]/g,"_").slice(0,20)}_${new Date().toISOString().replace(/[:.]/g,"-")}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(link.href);
}

function closeSession(){
    if (ws.readyState === WebSocket.OPEN) ws.close(1000,"Interview completed");
    location.href = "/";
}

/* ---------- –¥–æ–ø –∫–ª–∞–≤–∏—à–∏ ---------- */
document.getElementById("messageText").addEventListener("keydown", e=>{
    if (e.key==="Enter" && (e.ctrlKey||e.metaKey)){
        e.preventDefault();
        document.getElementById("chat-form").requestSubmit();
    }
});

/* ---------- —Å—Ç–∞—Ä—Ç ---------- */
connect();
</script>
</body>
</html>

